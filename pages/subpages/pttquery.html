<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<head>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.15.1/vis.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.15.1/vis.min.css" rel="stylesheet" type="text/css" />
<title>Study Abroad Crawler</title>

</head>
    <body>
    <h3>Welcome to PTT Studyabroad Search</h3>
    <h5>搜尋耗時較久 請耐心等候</h5>
        關鍵字: <input id="query"/> 

        <select id="selection">
            <option value="title">標題</option>
            <option value="content">內文</option>
        </select>
        <button id="search">Search</button>
        <br></br>
        <div id="load"></div>
        <!-- <progress id="progBar" value="0" max="100"></progress> -->
        <div id="results"></div>
    <script type="text/javascript"  charset = UTF-8>
  

    function load_view(data){
        var query = $("#query").val();
        var content_or_title = $( "#selection option:selected" ).text();
        for(i = 0; i < data.length; i++){
            if(data[i][content_or_title].search(query) != -1){
                var j = i + 1;
                $('#results').append('<br><div>' + '' + j + ': '+ data[i].標題 + "<br><a href="+ data[i].link +'>Link</a></div>');
            }       
        }
        $("#load").text("Finished");
        blink(false);

    }
    // testing url = https://api.myjson.com/bins/yhp0
    function get_data(){
        $("#load").text("Loading...");
        blink(true);
        // $("#progBar").show();
        // $.getJSON("https://api.myjson.com/bins/yhp0", function(json) {
        //     load_view(json);
        // });
        $.ajax({
          xhr: function()
          {
            var xhr = new window.XMLHttpRequest();
            //Upload progress
            xhr.upload.addEventListener("progress", function(evt){
              if (evt.lengthComputable) {
                var percentComplete = evt.loaded / evt.total;
                //Do something with upload progress
                console.log(percentComplete);
              }
            }, false);
            //Download progress
            xhr.addEventListener("progress", function(evt){
              if (evt.lengthComputable) {
                var percentComplete = evt.loaded / evt.total;
                //Do something with download progress
                console.log(percentComplete);
                $("#progBar").val(percentComplete*100);
              }
            }, false);
            return xhr;
          },
          type: 'GET',
          url: "data.json",
          data: {},
          success: function(data){
            load_view(data)
          }
        });
    }

    function on_ready(){
        // $("#progBar").hide();
        $('#search').click(function(){
            $( "#results" ).empty();
            get_data();
          });

        $('body').keypress(function(e) {
          if (e.keyCode == '13') {
            $( "#results" ).empty();
            get_data();
          }
      });
    }

    var blink_elements = [];
    function blink(turn_blink_on){
        if(turn_blink_on){
            var t = setInterval(function () {
                var ele = document.getElementById('load');
                ele.style.visibility = (ele.style.visibility == 'hidden' ? '' : 'hidden');
            }, 500);
            blink_elements.push(t);
        }else{
            t = blink_elements.pop();
            clearInterval(t);
        }
    }

    $(document).ready(on_ready);


    </script>
    </body>
</html>